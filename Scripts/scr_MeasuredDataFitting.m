clear all; close all; clc; figure(); hold on; grid on;
pkg load optim;

% Measured data
x = [5.00, 5.40, 5.80, 6.00, 6.50, 7.22, 7.50, 7.80, 8.10, 8.40, 8.80, 9.35, 9.78, 10.00, 10.30, 11.00, 11.60, 12.54, 13.26, 13.80, 14.00, 14.10, 14.20, 14.30, 14.40, 14.51, 15.30, 27.30, 27.43, 27.49, 35.16, 36.40, 37.00, 37.12, 37.15, 37.36, 44.50, 45.65, 46.32, 46.37, 46.60, 47.40, 50.00, 50.25, 51.00, 51.50, 53.00, 55.65, 56.20, 57.50];
y = [4813.00, 4760.00, 4685.00, 4646.00, 4547.00, 4413.00, 4356.00, 4295.00, 4230.00, 4172.00, 4091.00, 3981.00, 3900.00, 3860.00, 3801.00, 3676.00, 3566.00, 3478.00, 3199.00, 3106.00, 3086.00, 3065.00, 3046.00, 3029.00, 3009.00, 2997.00, 2911.00, 1929.00, 1894.00, 1892.00, 1440.00, 1390.00, 1367.00, 1340.00, 1371.00, 1370.00, 1018.00, 980.00, 1002.00, 1000.00, 994.00, 944.00, 870.00, 825.00, 811.00, 844.00, 800.00, 750.00, 749.00, 745.00];

% Trim
trim = [+18, -14];
x = x(1 + trim(1) : end + trim(2));
y = y(1 + trim(1) : end + trim(2));

% Model
f = @(k, x) (k(1) .* exp (k(2) .* (1 ./ (x + 273.15) - 1 / 298.15)));

% Initial guess
k0 = [2000, 3829];

% Perform model fitting
[B, R, J, COVB, MSE] = nlinfit(x, y, f, k0);

% Print and plot
printf("R25: %.1f, Beta: %.1f\r\n", B(1), B(2));
T = 0:0.1:80;
R = f(B, T);
plot(T, R ./ 1e3, '-b');
scatter(x, y ./ 1e3, 'r');
title('ER-6n 2007 IAT NTC model fitting');
xlabel('Temp [°C]');
ylabel('R [kOhm]');
